<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Generatore Turni 2025 — FERMO ogni 2 domeniche</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:18px;background:#f4f6fb;color:#111}
  .card{background:white;padding:16px;border-radius:10px;box-shadow:0 6px 20px rgba(15,23,42,0.06);max-width:1150px;margin:0 auto}
  h1{margin:0 0 8px;font-size:20px}
  label{display:block;margin-top:10px;font-weight:600}
  input[type="text"], input[type="number"], select{width:100%;padding:6px;border-radius:6px;border:1px solid #d6d9e6}
  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:13px}
  th,td{padding:6px;border:1px solid #e6e9ef;text-align:left}
  thead th{background:#f0f4ff}
  .fermo{background:#ffecec}
  .download{background:#0b8; color:white}
  .drag-handle{cursor:grab}
</style>
</head>
<body>
<div class="card">
<h1>Generatore Turni 2025 — logica FERMO</h1>

<p class="small">Gestisci consorziati con ordine drag&drop, modifica proprietario/affittuario/ore. Lo script genera calendario FERMO 2025.</p>

<h2>Consorziati</h2>
<table id="consorziatiTable">
<thead><tr><th>#</th><th>Proprietario</th><th>Affittuario</th><th>Ore</th><th>Drag</th></tr></thead>
<tbody></tbody>
</table>

<button id="addConsorziato">Aggiungi consorziato</button>

<h2>Parametri FERMO</h2>
<div style="display:flex;gap:12px;flex-wrap:wrap">
<div>
<label>Periodo FERMO</label>
<div style="display:flex;gap:4px">
<input type="date" id="period_start" value="2025-04-01"/>
<input type="date" id="period_end" value="2025-09-30"/>
</div>
</div>
<div>
<label>Domeniche: parità</label>
<select id="parity">
<option value="odd">Occorrenze dispari</option>
<option value="even">Occorrenze pari</option>
</select>
</div>
<div>
<label><input type="checkbox" id="include_aug15" checked/> Includi 15 agosto</label><br/>
<label><input type="checkbox" id="include_oct1"/> Includi 1 ottobre</label>
</div>
</div>

<button id="generate">Genera calendario</button>
<button id="download" class="download" style="display:none">Scarica CSV</button>

<div id="tablewrap"></div>

<script>
(() => {
const consorziati = [
  {id:1, proprietario:"Oggero F.lli", affittuario:"", ore:29.0},
  {id:2, proprietario:"Panero Giovanni", affittuario:"Oggero F.lli", ore:13.83},
  {id:3, proprietario:"Allasia Plant", affittuario:"", ore:10.0},
  {id:4, proprietario:"Villosio F.lli", affittuario:"", ore:19.5},
  {id:5, proprietario:"Massimino F.lli", affittuario:"", ore:13.5},
  {id:6, proprietario:"Martini Vincenzo", affittuario:"", ore:19.0},
  {id:7, proprietario:"Toselli Bartolomeo", affittuario:"", ore:20.0},
  {id:8, proprietario:"Panero Giorgio", affittuario:"", ore:23.0},
  {id:9, proprietario:"Panero Giuseppe", affittuario:"", ore:5.0},
  {id:10, proprietario:"Raso Michelino", affittuario:"", ore:10.0},
  {id:11, proprietario:"Rosso Sebastiano", affittuario:"", ore:12.0},
  {id:12, proprietario:"Bergesio Renato", affittuario:"", ore:28.75},
  {id:13, proprietario:"Bergesio Antonio", affittuario:"", ore:4.0},
  {id:14, proprietario:"Milano Dario", affittuario:"", ore:1.0},
  {id:15, proprietario:"Toselli Bartolomeo", affittuario:"", ore:12.67},
  {id:16, proprietario:"Brizio Matteo", affittuario:"Tosco Bernardino", ore:10.0},
  {id:17, proprietario:"Tosco Bernardino", affittuario:"", ore:36.75},
  {id:18, proprietario:"Camisassi Piergiorgio", affittuario:"", ore:11.5}
];

const tbody = document.querySelector("#consorziatiTable tbody");

function renderConsorziati() {
  tbody.innerHTML="";
  consorziati.forEach((c,index)=>{
    const tr = document.createElement("tr");
    tr.draggable=true;
    tr.innerHTML=`
      <td>${index+1}</td>
      <td><input type="text" value="${c.proprietario}" data-id="${c.id}" data-field="proprietario"/></td>
      <td><input type="text" value="${c.affittuario}" data-id="${c.id}" data-field="affittuario"/></td>
      <td><input type="number" value="${c.ore}" step="0.01" min="0" data-id="${c.id}" data-field="ore"/></td>
      <td class="drag-handle">⇅</td>
    `;
    tbody.appendChild(tr);
  });
}

// Drag & Drop reordering
let dragSrcIndex = null;
tbody.addEventListener('dragstart',e=>{
  dragSrcIndex=[...tbody.children].indexOf(e.target);
  e.dataTransfer.effectAllowed='move';
});
tbody.addEventListener('dragover',e=>{ e.preventDefault(); });
tbody.addEventListener('drop',e=>{
  e.preventDefault();
  const dragDstIndex=[...tbody.children].indexOf(e.target.closest('tr'));
  if(dragDstIndex===-1||dragSrcIndex===null) return;
  const moved = consorziati.splice(dragSrcIndex,1)[0];
  consorziati.splice(dragDstIndex,0,moved);
  renderConsorziati();
});

// Update consorziati from input changes
tbody.addEventListener('input',e=>{
  const id=parseInt(e.target.dataset.id);
  const field=e.target.dataset.field;
  const cons=consorziati.find(c=>c.id===id);
  if(field==="ore") cons[field]=parseFloat(e.target.value);
  else cons[field]=e.target.value;
});

document.getElementById("addConsorziato").addEventListener("click",()=>{
  const maxId = consorziati.length ? Math.max(...consorziati.map(c=>c.id)) : 0;
  consorziati.push({id:maxId+1, proprietario:"Nuovo", affittuario:"", ore:0});
  renderConsorziati();
});

renderConsorziati();

// --- CALENDARIO ---
function fmt(d){ return d.toISOString().slice(0,10); }
function generateCalendar2025(){
  const year=2025;
  const start=new Date(Date.UTC(year,0,1));
  const end=new Date(Date.UTC(year,11,31));
  const days=[];
  for(let d=new Date(start);d<=end;d.setUTCDate(d.getUTCDate()+1)) days.push(new Date(d));
  return days;
}
function sundaysInRange(startDate,endDate){
  const res=[];
  for(let d=new Date(startDate);d<=endDate;d.setUTCDate(d.getUTCDate()+1))
    if(d.getUTCDay()===0) res.push(new Date(d));
  return res;
}

document.getElementById('generate').addEventListener('click',()=>{
  const periodStart=new Date(document.getElementById('period_start').value+'T00:00:00Z');
  const periodEnd=new Date(document.getElementById('period_end').value+'T23:59:59Z');
  const parity=document.getElementById('parity').value;
  const includeAug15=document.getElementById('include_aug15').checked;
  const includeOct1=document.getElementById('include_oct1').checked;

  const days=generateCalendar2025();
  const sundays=sundaysInRange(periodStart,periodEnd);
  const sundayIndex={};
  sundays.forEach((d,i)=>sundayIndex[fmt(d)]=i+1);

  const fermoSet=new Set();
  sundays.forEach((d,i)=>{
    const occ=i+1, isOdd=(occ%2)===1;
    const wantOdd=(parity==='odd');
    if((isOdd&&wantOdd)||(!isOdd&&!wantOdd)) fermoSet.add(fmt(d));
  });
  if(includeAug15){ const aug=new Date(Date.UTC(2025,7,15)); if(aug>=periodStart&&aug<=periodEnd) fermoSet.add(fmt(aug)); }
  if(includeOct1){ const oct1=new Date(Date.UTC(2025,9,1)); if(oct1>=periodStart&&oct1<=periodEnd) fermoSet.add(fmt(oct1)); }

  const out=[];
  days.forEach(d=>{
    const dateStr=fmt(d);
    const wk=['Domenica','Lunedì','Martedì','Mercoledì','Giovedì','Venerdì','Sabato'][d.getUTCDay()];
    const day=d.getUTCDate(), month=d.getUTCMonth()+1;
    const isFermo=fermoSet.has(dateStr);
    const who=isFermo? consorziati.map(c=>`${c.proprietario}${c.affittuario?'/'+c.affittuario:''}(${c.ore}h)`).join('; '):'';
    out.push({date:dateStr,weekday:wk,day,month,isFermo: isFermo?'FERMO':'', whoFermo:who});
  });

  let html='<table><thead><tr><th>Data</th><th>Giorno</th><th>GG</th><th>MM</th><th>FERMO</th><th>Consorziati FERMO</th></tr></thead><tbody>';
  out.forEach(r=>{
    html+=`<tr ${r.isFermo?'class="fermo"':''}><td>${r.date}</td><td>${r.weekday}</td><td>${r.day}</td><td>${r.month}</td><td>${r.isFermo}</td><td>${r.whoFermo}</td></tr>`;
  });
  html+='</tbody></table>';
  document.getElementById('tablewrap').innerHTML=html;

  // download CSV
  const dl=document.getElementById('download'); dl.style.display='inline-block';
  dl.onclick=()=>{
    const cols=['date','weekday','day','month','fermo','whoFermo'];
    const lines=[cols.join(',')];
    out.forEach(r=>{
      const quote=s=>`"${s}"`;
      lines.push([r.date,r.weekday,r.day,r.month,r.isFermo,r.whoFermo].map(quote).join(','));
    });
    const csv=lines.join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='calendario_2025_fermo.csv'; a.click(); URL.revokeObjectURL(url);
  };
});
})();
</script>
</body>
</html>
